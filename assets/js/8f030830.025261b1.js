"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[618],{5201:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>r,toc:()=>c});var a=i(5893),s=i(1151);const t={sidebar_position:3,title:"Development"},o=void 0,r={id:"development",title:"Development",description:"Running Tests",source:"@site/docs/development.md",sourceDirName:".",slug:"/development",permalink:"/astraios/docs/development",draft:!1,unlisted:!1,editUrl:"https://github.com/paion-data/astraios/tree/master/docs/docs/development.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"Development"},sidebar:"tutorialSidebar",previous:{title:"Setup",permalink:"/astraios/docs/setup"},next:{title:"JPA through Elide Middleware",permalink:"/astraios/docs/elide"}},l={},c=[{value:"Running Tests",id:"running-tests",level:2},{value:"Packaging",id:"packaging",level:2},{value:"Running Webservice in Docker Compose",id:"running-webservice-in-docker-compose",level:2},{value:"Step 1: Defining Data Models",id:"step-1-defining-data-models",level:3},{value:"Step 2: Spinning Up Docker Compose",id:"step-2-spinning-up-docker-compose",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"Database Does Not Have My Model Packages&#39;s Bean Table",id:"database-does-not-have-my-model-packagess-bean-table",level:4},{value:"Entity Missing Default Constructor",id:"entity-missing-default-constructor",level:3},{value:"How to Exclude GraphQL Feature",id:"how-to-exclude-graphql-feature",level:3},{value:"Querying Webservice",id:"querying-webservice",level:2},{value:"GraphQL Queries through GraphiQL",id:"graphql-queries-through-graphiql",level:3},{value:"Install GraphiQL (on Mac)",id:"install-graphiql-on-mac",level:4},{value:"Quering GraphQL Endpoint",id:"quering-graphql-endpoint",level:4},{value:"TypeScript/JavaScript Axios",id:"typescriptjavascript-axios",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"running-tests",children:"Running Tests"}),"\n",(0,a.jsxs)(n.p,{children:["The IT tests will run against an ",(0,a.jsx)(n.a,{href:"https://github.com/QubitPi/jersey-webservice-template-jpa-data-model/blob/master/src/main/java/com/qubitpi/ws/jersey/template/models/Book.java",children:"example model"})," so make sure the following environment variable is set to point to this\nmodel:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"export TEST_MODEL_PACKAGE_NAME=com.qubitpi.ws.jersey.template.models\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Next, download the model to ",(0,a.jsx)(n.em,{children:"CLASSPATH"})," by setting up the ",(0,a.jsx)(n.code,{children:"~/.m2/settings.xml"})," with"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:'<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"\n          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0\n                      http://maven.apache.org/xsd/settings-1.0.0.xsd">\n\n    <profiles>\n        <profile>\n            <id>astraios-models</id>\n            <properties>\n                <model.package.jar.group.id>com.qubitpi</model.package.jar.group.id>\n                <model.package.jar.artifact.id>jersey-webservice-template-jpa-data-model</model.package.jar.artifact.id>\n                <model.package.jar.version>1.0.0</model.package.jar.version>\n            </properties>\n        </profile>\n    </profiles>\n\n    <activeProfiles>\n        <activeProfile>astraios-models</activeProfile>\n    </activeProfiles>\n</settings>\n'})}),"\n",(0,a.jsx)(n.p,{children:"Then execute the following commands to run both unit and integration tests:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"mvn clean verify\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For IT tests, we use ",(0,a.jsx)(n.a,{href:"https://qubitpi.github.io/testcontainers-java/",children:"Testcontainers"})," instead of ",(0,a.jsx)(n.a,{href:"https://mysql.jcabi.com/",children:"jcabi-mysql"})," because the latter is hard to configure and debug and\n",(0,a.jsx)(n.a,{href:"https://qubitpi.github.io/testcontainers-java/",children:"Testcontainers"})," support more types of db, such as mongo"]}),"\n",(0,a.jsx)(n.h2,{id:"packaging",children:"Packaging"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"mvn clean package\n"})}),"\n",(0,a.jsxs)(n.p,{children:["A ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/WAR_(file_format)",children:"WAR file"})," named ",(0,a.jsx)(n.strong,{children:"astraios-1.0-SNAPSHOT.war"})," will\nbe generated under ",(0,a.jsx)(n.em,{children:"target"})," directory for ",(0,a.jsx)(n.a,{href:"#running-in-standalone-jetty",children:"running in Jetty"})]}),"\n",(0,a.jsx)(n.h2,{id:"running-webservice-in-docker-compose",children:"Running Webservice in Docker Compose"}),"\n",(0,a.jsx)(n.h3,{id:"step-1-defining-data-models",children:"Step 1: Defining Data Models"}),"\n",(0,a.jsxs)(n.p,{children:["To inject ",(0,a.jsx)(n.a,{href:"https://github.com/yahoo/elide/tree/master/elide-standalone#create-models",children:"Elide model package"}),", simply put\nthe models in a separate JAR and include it as a dependency in POM. If the model package is internal and cannot be\nvisible publicly, either make the astraios project private or public with model package dependency info\n",(0,a.jsx)(n.a,{href:"https://maven.apache.org/examples/injecting-properties-via-settings.html",children:"injected via settings.xml"}),", for example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<project>\n\n    ...\n\n    <dependencies>\n        <dependency>\n            <groupId>${model.package.jar.group.id}</groupId>\n            <artifactId>${model.package.jar.artifact.id}</artifactId>\n            <version>${model.package.jar.version}</version>\n        </dependency>\n    </dependencies>\n\n    ...\n\n    <repositories>\n        <repository>\n            <id>${astraios.model.package.repo.id}</id>\n            <name>Astraios model pacakge JAR repository</name>\n            <url>${astraios.model.package.repo.url}</url>\n        </repository>\n    </repositories>\n\n    ...\n\n</project>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["with a corresponding ",(0,a.jsx)(n.code,{children:"~/.m2/settings.xml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:'<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"\n          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0\n                      http://maven.apache.org/xsd/settings-1.0.0.xsd">\n\n    <profiles>\n        <profile>\n            <id>astraios-config-properties</id>\n            <properties>\n                <model.package.jar.group.id>com.mycompnay</model.package.jar.group.id>\n                <model.package.jar.artifact.id>my-model-package</model.package.jar.artifact.id>\n                <model.package.jar.version>1.0.7</model.package.jar.version>\n                <astraios.model.package.repo.id>mycompany-maven-repo-id</astraios.model.package.repo.id>\n                <astraios.model.package.repo.url>\n                    https://private.mvnrepository.com/artifact/com.company/my-model-package\n                </astraios.model.package.repo.url>\n            </properties>\n        </profile>\n    </profiles>\n\n\n    <activeProfiles>\n        <activeProfile>astraios-config-properties</activeProfile>\n    </activeProfiles>\n\n    <servers>\n        ...\n    </servers>\n</settings>\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Lastly, if IntelliJ IDE is used for developing Astraios, please make sure to let IDE pick up the ",(0,a.jsx)(n.code,{children:"~/.m2/settings.xml"})," by\nunchecking the ",(0,a.jsx)(n.em,{children:"Use settings from .mvn/maven.config"}),":"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Error loading load-m2-settings.png",src:i(8200).Z+"",width:"3584",height:"2240"})}),"\n",(0,a.jsx)(n.h3,{id:"step-2-spinning-up-docker-compose",children:"Step 2: Spinning Up Docker Compose"}),"\n",(0,a.jsx)(n.p,{children:"Astraios can run in [Docker Compose] for the following purposes"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Decoupling frontend and backend developments"}),"\n",(0,a.jsx)(n.li,{children:"Making it easy to run E2E testing of Astraios-backed application in CI/CD"}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{type:"caution",children:(0,a.jsxs)(n.p,{children:["Docker Compose designed here is intended for local development and testing purposes ONLY! ",(0,a.jsx)(n.em,{children:"It is strongly discouraged\nto run this Docker Compose in production!"})]})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Error Loading docker-compose.png",src:i(3386).Z+"",width:"732",height:"492"})}),"\n",(0,a.jsx)(n.p,{children:"Simply run:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"git clone git@github.com:paion-data/astraios.git\ncd astraios\nmvn clean package\nMODEL_PACKAGE_NAME=$ASTRAIOS_MODEL_PACKAGE_NAME docker compose up --build --force-recreate\n"})}),"\n",(0,a.jsxs)(n.p,{children:["where the value of ",(0,a.jsx)(n.code,{children:"$ASTRAIOS_MODEL_PACKAGE_NAME"})," variable is the package in config JAR that contains all\n",(0,a.jsx)(n.a,{href:"https://elide.io/pages/guide/v7/02-data-model.html",children:"elide models"}),". It can be set, for example, at command line with:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"export $TEST_MODEL_PACKAGE_NAME=com.mycompany.models\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The variable will be ",(0,a.jsx)(n.a,{href:"https://stackoverflow.com/a/58900415",children:"passed"})," into Docker Compose file."]}),"\n",(0,a.jsxs)(n.admonition,{type:"tip",children:[(0,a.jsx)(n.p,{children:"The MySQL database, if running correctly, can be accessed from host machine via"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"mysql -h localhost -P 3306 -D elide --protocol=tcp -u root -proot\n"})}),(0,a.jsxs)(n.p,{children:["Note all data is in ",(0,a.jsx)(n.code,{children:"elide"})," database which we have specified to use in the command above."]})]}),"\n",(0,a.jsx)(n.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsx)(n.h4,{id:"database-does-not-have-my-model-packagess-bean-table",children:"Database Does Not Have My Model Packages's Bean Table"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.em,{children:"If tests is running in IntelliJ IDE"}),", make sure the model package JAR it is in IDE's ",(0,a.jsx)(n.strong,{children:"External Libraries"})]}),"\n",(0,a.jsxs)(n.p,{children:["Otherwise, the dependency injection didn't find a bean class under the package specified by\n",(0,a.jsx)(n.a,{href:"#step-1-defining-data-models",children:"$TEST_MODEL_PACKAGE_NAME"})]}),"\n",(0,a.jsx)(n.h3,{id:"entity-missing-default-constructor",children:"Entity Missing Default Constructor"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"[main] INFO  o.h.m.i.EntityInstantiatorPojoStandard - HHH000182: No default (no-argument) constructor for\nclass: ... (class must be instantiated by Interceptor)\n"})}),"\n",(0,a.jsx)(n.p,{children:"Simply add a no-args constructor to the bean class."}),"\n",(0,a.jsx)(n.h3,{id:"how-to-exclude-graphql-feature",children:"How to Exclude GraphQL Feature"}),"\n",(0,a.jsx)(n.p,{children:"To optionally disable GraphQL endpoints, exclude corresponding dependencies in POM. For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"        <dependency>\n            <groupId>com.yahoo.elide</groupId>\n            <artifactId>elide-core</artifactId>\n            <version>7.0.0-pr6</version>\n            <exclusions>\n                <exclusion>\n                    <groupId>com.yahoo.elide</groupId>\n                    <artifactId>elide-graphql</artifactId>\n                </exclusion>\n            </exclusions>\n        </dependency>\n"})}),"\n",(0,a.jsx)(n.h2,{id:"querying-webservice",children:"Querying Webservice"}),"\n",(0,a.jsx)(n.h3,{id:"graphql-queries-through-graphiql",children:"GraphQL Queries through GraphiQL"}),"\n",(0,a.jsx)(n.h4,{id:"install-graphiql-on-mac",children:"Install GraphiQL (on Mac)"}),"\n",(0,a.jsxs)(n.p,{children:["via ",(0,a.jsx)(n.a,{href:"https://formulae.brew.sh/cask/graphiql",children:"Homebrew"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"brew install --cask graphiql\n"})}),"\n",(0,a.jsx)(n.h4,{id:"quering-graphql-endpoint",children:"Quering GraphQL Endpoint"}),"\n",(0,a.jsx)(n.p,{children:"Let's crete a book:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-graphql",children:'mutation {\n  book(op: UPSERT, data:{title: "Pride & Prejudice"}) {\n    edges {\n      node {\n        id\n        title\n      }\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Error loading graphiql-mutation-example.png",src:i(9415).Z+"",width:"3584",height:"945"})}),"\n",(0,a.jsx)(n.p,{children:"We can create few more books, sort and paginate them with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-graphql",children:'{\n  book(sort: "-id", first: "1", after: "0") {\n    edges {\n      node {\n        id\n        title\n      }\n    }\n    pageInfo {\n      totalRecords\n      startCursor\n      endCursor\n      hasNextPage\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"typescriptjavascript-axios",children:"TypeScript/JavaScript Axios"}),"\n",(0,a.jsx)(n.admonition,{type:"caution",children:(0,a.jsxs)(n.p,{children:["Note that any serialization of TS/JS object (",(0,a.jsx)(n.code,{children:"someObject"}),") should be done with\n",(0,a.jsx)(n.code,{children:"JSON.stringify(someObject).replace(/\"/g, '\\\\\"')"}),", otherwise the GraphQL query won't be parsed properly by webservice."]})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'import axios from "axios";\n\nconst JERSEY_WEBSERVICE_TEMPLATE_GRAPHQL_API_ENDPOINT = "https://myservice.com/v1/data";\n\nexport class Client {\n  public saveOrUpdate(book: Book, userId: string, accessToken: string): Promise<any> {\n    const someJsonField = JSON.stringify({ field1: book.field1, field2: book.field2 }).replace(/"/g, \'\\\\"\');\n\n    return this.postGraphQLQuery(\n      `\n      mutation saveGraph {\n        graph(op: UPSERT, data: {\n          id: "${book.id}"\n          title: "${book.title}"\n          authorId: "${book.authorId}"\n          jsonField: "${someJsonField}"\n        }) {\n          edges {\n            node {\n              id\n              title\n              author\n            }\n          }\n        }\n      }\n      `,\n      accessToken\n    );\n  }\n\n  public getBooksByAuthorId(authorId: string, accessToken: string) {\n    return this.postGraphQLQuery(\n      `\n      query getBooksByAuthorId {\n        book(filter:"authorId==${authorId}") {\n          edges {\n            node {\n              id\n              title\n            }\n          }\n        }\n      }\n      `,\n      accessToken\n    );\n  }\n\n  private postGraphQLQuery(query: string, accessToken: string): Promise<any> {\n    return axios\n      .post(JERSEY_WEBSERVICE_TEMPLATE_GRAPHQL_API_ENDPOINT, { query: query }, this.getHeaders(accessToken))\n      .then((response) => {\n        return response;\n      });\n  }\n\n  private getHeaders(token: string) {\n    return {\n      headers: {\n        Accept: "application/json",\n        "Content-Type": "application/json",\n        Authorization: "Bearer " + token,\n      },\n    };\n  }\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},3386:(e,n,i)=>{i.d(n,{Z:()=>a});const a=i.p+"assets/images/docker-compose-c901c60cce997d66d07b7b62b7678287.png"},9415:(e,n,i)=>{i.d(n,{Z:()=>a});const a=i.p+"assets/images/graphiql-mutation-example-747c388455a51d3a6bb4f1aa9242f3b7.png"},8200:(e,n,i)=>{i.d(n,{Z:()=>a});const a=i.p+"assets/images/load-m2-settings-8c90138e53bba78c2a44ea1c6304f377.png"},1151:(e,n,i)=>{i.d(n,{Z:()=>r,a:()=>o});var a=i(7294);const s={},t=a.createContext(s);function o(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);